<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const harexsLimit = (maxCount) => {
        let activeCount = 0;
        let waitTask = [];

        const execute = (asyncFn, ...args) => {
          return new Promise((resolve, reject) => {
            const task = create(asyncFn, args, resolve, reject);
            if (activeCount >= maxCount) {
              waitTask.push(task);
            } else {
              task();
            }
          });
        };

        const create = (asyncFn, args, resolve, reject) => {
          return () => {
            asyncFn(...args)
              .then(resolve)
              .catch(reject)
              .finally(() => {
                activeCount--;
                if (waitTask.length) {
                  waitTask.shift()();
                }
              });
            activeCount++;
          };
        };

        return execute;
      };

      let limitP = harexsLimit(3);

      function sleep(sec) {
        return new Promise((resolve, reject) => {
          console.log("本函数的执行时要等待" + sec + "秒");
          setTimeout(() => {
            console.log("等待了" + sec + "秒");
            resolve();
          }, sec * 1000);
        });
      }

      limitP(sleep, 1);
      limitP(sleep, 1.1);
      limitP(sleep, 1.2);
      limitP(sleep, 3);
      limitP(sleep, 1.3);
    </script>
  </body>
</html>
